# Must be run from crate root
# docker build -f ./dockers/Dockerfile.server_app_test .

FROM rustlang/rust:nightly-bullseye as CACHE
WORKDIR poetshuffle
RUN mkdir -p entity/src && \
    echo "" > entity/src/mod.rs && \
    mkdir -p migration/src && \
    echo "" > migration/src/lib.rs && \
    mkdir -p server/src && \
    echo "fn main() {}" > server/src/main.rs
COPY ./server/Cargo.toml ./server
COPY ./entity/Cargo.toml ./entity
COPY ./migration/Cargo.toml ./migration
RUN cd server && cargo fetch

FROM rustlang/rust:nightly-bullseye as BUILD
COPY --from=CACHE /usr/local/cargo /usr/local/cargo
COPY .. ./poetshuffle/
WORKDIR poetshuffle
RUN cargo +nightly build --release --package server --features app-test

FROM debian:latest
COPY --from=BUILD /poetshuffle/target/release/server ./bin
RUN apt-get update
RUN apt-get install -y curl
EXPOSE 3001
ENTRYPOINT ["server"]


